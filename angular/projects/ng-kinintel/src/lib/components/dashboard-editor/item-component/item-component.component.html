<div class="alert-panel" *ngIf="showAlertData" (click)="showAlertData = false">
    <div class="align-center flex-col w-3/4 m-auto">
        <mat-icon>notification_important</mat-icon>
        <h2 class="mb-0">Alert Notification</h2>
        <p class="text-center">The following alerts have been triggered based on the criteria set for this dashboard
            item...</p>
        <div class="alert-item mb-2" *ngFor="let alertItem of alertData"
             [innerHTML]="alertItem.notificationMessage">
        </div>
    </div>
</div>

<div class="item-disabled">
    <p>{{general.name || dashboardItemType.label}}</p>
    <mat-icon>block</mat-icon>
    <p class="disabled-notice">{{dependencies.notice || 'No Data Available'}}</p>
</div>

<ng-template [ngIf]="dragItem">
    <mat-icon>{{dashboardItemType.icon}}</mat-icon>
    {{dashboardItemType.label}}
</ng-template>
<div class="alert-widget" *ngIf="alert" (click)="showAlertData = true;">
    <button mat-icon-button>
        <mat-icon>notification_important</mat-icon>
    </button>
    <div class="alert-summaries">
        <span class="mr-2" *ngFor="let alertItem of alertData">
            {{alertItem.summaryMessage}}
        </span>
    </div>
</div>

<ng-template
    [ngIf]="!dragItem && !dashboardDatasetInstance && !dashboardItemType.headingValue && !dashboardItemType._editing">
    <button mat-stroked-button color="primary" class="config-button" (click)="configure()">
        Configure {{dashboardItemType.label}}
    </button>
</ng-template>

<div class="loading-item" *ngIf="!dragItem && loadingItem">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading {{general.name || dashboardItemType.label}} ...</p>
</div>

<ng-template [ngIf]="!itemLocked">
    <button mat-icon-button class="edit-widget" *ngIf="viewOnly && editAlerts"
            [matMenuTriggerFor]="alertMenu">
        <mat-icon>add_alert</mat-icon>
    </button>
    <mat-menu #alertMenu="matMenu" class="no-menu-padding">
        <button mat-menu-item (click)="editItemAlerts(null)">
            <mat-icon>add</mat-icon>
            <span>New Alert</span>
        </button>
        <ng-template [ngIf]="dashboardDatasetInstance">
            <div mat-menu-item class="flex items-center justify-between p-0 "
                 [ngClass]="{'border border-t border-b-0 border-r-0 border-l-0 border-solid border-gray-200': i === 0}"
                 *ngFor="let alert of dashboardDatasetInstance.alerts; let i = index">
                <div class="px-4 flex items-center" (click)="editItemAlerts(alert, i)">
                    <mat-icon>edit</mat-icon>
                    <span>{{alert.title}}</span>
                </div>
                <div class="flex items-center">
                    <div class="mx-2 divider"></div>
                    <button mat-icon-button (click)="removeAlert($event, alert, i)">
                        <mat-icon class="mx-2 text-red-600 m-0">highlight_off</mat-icon>
                    </button>
                </div>

            </div>
        </ng-template>
    </mat-menu>

    <button *ngIf="!dragItem && !viewOnly" mat-icon-button class="edit-widget "
            [matMenuTriggerFor]="editMenu">
        <mat-icon>more_vert</mat-icon>
    </button>
    <mat-menu #editMenu="matMenu">
        <button mat-menu-item (click)="configure()">Edit Item</button>
        <button mat-menu-item (click)="removeWidget($event)">Delete Item</button>
    </mat-menu>
</ng-template>

<ng-template [ngIf]="!dragItem && dashboardItemType.type === 'heading'">

    <div class="item-heading" *ngIf="!dashboardItemType._editing">
        {{bindParametersInString(dashboardItemType.headingValue)}}
    </div>

    <input type="text" *ngIf="dashboardItemType._editing" [(ngModel)]="dashboardItemType.headingValue"
           (blur)="updateHeading($event)" class="w-11/12">

</ng-template>

<ng-template [ngIf]="!dragItem && !loadingItem && (chartData || dataset)">
    <div class="item-title " *ngIf="general.name" [innerHTML]="general.evaluatedName"
         [ngClass]="{'pb-4': !general.description, 'pb-2': general.description}"></div>

    <div class="item-description " *ngIf="general.description"
         [innerHTML]="general.evaluatedDescription"></div>

    <div class="item-container" [ngClass]="{'flex justify-center': dashboardItemType.type === 'image',
        'p-px': (dashboardItemType.type === 'table' || general.transparent), 'overflow-hidden': !!chartData,
        'flex items-center': dashboardItemType.type === 'metric'}">

        <ng-template [ngIf]="dashboardItemType.type === 'text' && textData.value">
            <div *ngIf="textData.safeTextData" [innerHTML]="textData.safeTextData"></div>
        </ng-template>

        <ng-template [ngIf]="dashboardItemType.type === 'metric'">
            <div class="w-full">
                <dt class="text-base font-normal text-gray-900">{{metric.title}}</dt>
                <dd class="mt-1 flex items-baseline justify-between md:block lg:flex">
                    <div class="flex items-baseline text-2xl font-semibold text-indigo-600">
                        {{metric.mainValue}}
                        <span *ngIf="metric.subMetric" class="ml-2 text-sm font-medium text-gray-500">from {{metric.subValue}}
                            <span class="text-xs">({{metric.subTitle}})</span></span>
                    </div>

                    <div *ngIf="metric.showSubChange" class="inline-flex items-baseline px-2.5 py-0.5 rounded-full text-sm font-medium md:mt-2 lg:mt-0"
                        [ngClass]="{'bg-green-100 text-green-800': metric.mainValue >= metric.subValue, 'bg-red-100 text-red-800': metric.mainValue < metric.subValue}">
                        <!-- Heroicon name: mini/arrow-up -->
                        <svg *ngIf="metric.mainValue >= metric.subValue" class="-ml-1 mr-0.5 h-5 w-5 flex-shrink-0 self-center text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M10 17a.75.75 0 01-.75-.75V5.612L5.29 9.77a.75.75 0 01-1.08-1.04l5.25-5.5a.75.75 0 011.08 0l5.25 5.5a.75.75 0 11-1.08 1.04l-3.96-4.158V16.25A.75.75 0 0110 17z" clip-rule="evenodd" />
                        </svg>
                        <svg *ngIf="metric.mainValue < metric.subValue " xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                             class="-ml-1 mr-0.5 h-5 w-5 flex-shrink-0 self-center text-red-500">
                            <path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v10.638l3.96-4.158a.75.75 0 111.08 1.04l-5.25 5.5a.75.75 0 01-1.08 0l-5.25-5.5a.75.75 0 111.08-1.04l3.96 4.158V3.75A.75.75 0 0110 3z" clip-rule="evenodd" />
                        </svg>
                        {{metric.difference}}
                    </div>
                </dd>
            </div>
        </ng-template>

        <ng-template [ngIf]="dashboardItemType.type === 'image'">
            <div class="w-auto h-full">
                <img *ngIf="imageData.source" [src]="imageData.source" alt=""
                     (error)="imageError = true">
            </div>

            <div *ngIf="!imageData.source || imageError" class="relative flex items-center justify-center">
                <p class="z-10 text-lg">No image</p>
                <svg xmlns="http://www.w3.org/2000/svg" class="filter blur-sm absolute w-auto h-full text-gray-300"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
            </div>
        </ng-template>

        <canvas baseChart *ngIf="chartData" style="height: 200px"
                [datasets]="chartData"
                [labels]="dashboardItemType.labels"
                [options]="{tooltips: { titleFontSize: 0 }, responsive:true, maintainAspectRatio: false}"
                [colors]="[{borderColor: dashboardItemType.borderColor,backgroundColor: dashboardItemType.backgroundColor}]"
                [legend]="!!dashboardItemType.legend"
                [chartType]="dashboardItemType.type"
                [plugins]="[]">
        </canvas>

        <ng-template [ngIf]="dashboardItemType.type === 'table'">

            <table class="min-w-full border-separate" style="border-spacing: 0">
                <thead class="bg-gray-50 ">
                <tr>
                    <ng-template ngFor let-column [ngForOf]="dataset.columns">
                        <th scope="col" *ngIf="!hiddenColumns[column.name]" (click)="sortHeader(column)"
                            class="cursor-pointer sticky top-0 z-10 border-b border-gray-300 bg-gray-50 bg-opacity-75 p-3 text-left text-xs font-semibold text-gray-900 backdrop-blur backdrop-filter">
                            <div class="flex items-center ">
                                {{column.title}}
                                <svg *ngIf="column.direction === 'asc'"
                                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                     stroke="currentColor" class="stroke-3 text-gray-400 ml-1 w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" />
                                </svg>
                                <svg *ngIf="column.direction === 'desc'" xmlns="http://www.w3.org/2000/svg" fill="none"
                                     viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="stroke-3 text-gray-400 ml-1 w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" />
                                </svg>
                            </div>
                        </th>
                    </ng-template>
                </tr>
                </thead>
                <tbody class="bg-white ">
                <tr *ngFor="let dataItem of dataset.allData"
                    [ngClass]="{'hover:bg-gray-50 cursor-pointer ': (tabular.actionRows && tabular.cta)}"
                    (click)="(tabular.actionRows && tabular.cta) ? callToActionLink(tabular.cta, dataItem) : null">
                    <ng-template ngFor let-column [ngForOf]="dataset.columns" let-i=index>
                        <td *ngIf="!hiddenColumns[column.name]"
                            [title]="(tableCells[column.name] && tableCells[column.name].maxWidth) ? dataItem[column.name] : ''"
                            class="border-b border-gray-200  px-3 py-2 text-sm text-gray-500 relative"
                            [ngClass]="{'whitespace-nowrap': !tabular.expandRows, 'font-medium text-gray-900': i === 0}"
                            [ngStyle]="{'width': '', 'max-width': (tableCells[column.name] && tableCells[column.name].maxWidth) ? tableCells[column.name].maxWidth + 'px' : null, 'overflow': (tableCells[column.name] && tableCells[column.name].maxWidth) ? 'hidden' : null, 'text-overflow': (tableCells[column.name] && tableCells[column.name].maxWidth) ? 'ellipsis' : null}">
                            <ng-template [ngIf]="tabular.expandRows">
                                <div *ngIf="!_.isPlainObject(dataItem[column.name])" [innerHTML]="dataItem[column.name]"></div>
                                <div *ngIf="_.isPlainObject(dataItem[column.name])" [innerHTML]="dataItem[column.name].cellValue"></div>
                            </ng-template>
                            <ng-template [ngIf]="!tabular.expandRows && _.isPlainObject(dataItem[column.name])">
                                <div [innerHTML]="dataItem[column.name].cellValue"
                                     [ngStyle]="{'max-width': (tableCells[column.name] && tableCells[column.name].maxWidth) ? tableCells[column.name].maxWidth + 'px' : null, 'overflow': (tableCells[column.name] && tableCells[column.name].maxWidth) ? 'hidden' : null, 'text-overflow': (tableCells[column.name] && tableCells[column.name].maxWidth) ? 'ellipsis' : null}"></div>
                            </ng-template>
                            <ng-template [ngIf]="!tabular.expandRows && !_.isPlainObject(dataItem[column.name])">
                                <ng-template
                                    [ngIf]="dataItem[column.name] && String(dataItem[column.name]).length <= 100">
                                    {{dataItem[column.name]}}
                                </ng-template>
                                <ng-template
                                    [ngIf]="dataItem[column.name] && String(dataItem[column.name]).length > 100">
                                    <div
                                        [ngStyle]="{'max-width': (tableCells[column.name] && tableCells[column.name].maxWidth) ? tableCells[column.name].maxWidth + 'px' : null, 'overflow': (tableCells[column.name] && tableCells[column.name].maxWidth) ? 'hidden' : null, 'text-overflow': (tableCells[column.name] && tableCells[column.name].maxWidth) ? 'ellipsis' : null}"
                                        [title]="dataItem[column.name]">{{dataItem[column.name].substring(0, 100) + '...'}}</div>
                                </ng-template>
                                <ng-template [ngIf]="!dataItem[column.name]">
                                    {{dataItem[column.name]}}
                                </ng-template>
                            </ng-template>
                        </td>
                    </ng-template>

                </tr>
                </tbody>
            </table>
            <div *ngIf="!tabular.hidePager" class="p-4 sticky left-0 flex items-center justify-between">
                <select [value]="limit" (change)="pageSizeChange($event.target.value)"
                        class="mr-8 ">
                    <option [value]="1">1</option>
                    <option [value]="5">5</option>
                    <option [value]="10">10</option>
                    <option [value]="25">25</option>
                    <option [value]="50">50</option>
                    <option [value]="100">100</option>
                    <option [value]="250">250</option>
                    <option [value]="1000">1000</option>
                </select>
                <div>
                    <button mat-icon-button class="mr-4" (click)="decreaseOffset()" [disabled]="page <= 1">
                        <mat-icon>chevron_left</mat-icon>
                    </button>
                    <button mat-icon-button (click)="increaseOffset()" [disabled]="endOfResults">
                        <mat-icon>chevron_right</mat-icon>
                    </button>
                </div>
            </div>
        </ng-template>

        <ng-template [ngIf]="dashboardItemType.type === 'words'">
            <angular-d3-cloud *ngIf="wordCloud.data"
                [data]="wordCloud.data"
                [width]="wordCloud.width"
                [height]="wordCloud.height"
                [padding]="5"
                font="serif"
                [rotate]="0"
                [autoFill]="true"
            ></angular-d3-cloud>
        </ng-template>

    </div>

    <div class="footer w-full bg-gray-50 px-5 py-1 text-gray-600 border-b border-gray-200 text-xs"
         [ngClass]="{'border-b': callToAction && Object.keys(callToAction).length}"
         *ngIf="general.footer" [innerHTML]="general.evaluatedFooter"></div>

    <div class="call-to-action w-full bg-gray-50 px-5 py-3" *ngIf="callToAction && Object.keys(callToAction).length">
        <div class="text-sm">
            <a class="font-medium text-cta flex items-center"
               (click)="callToActionLink(callToAction)">
                {{callToAction.label}}
                <mat-icon>chevron_right</mat-icon>
            </a>
        </div>
    </div>

</ng-template>
