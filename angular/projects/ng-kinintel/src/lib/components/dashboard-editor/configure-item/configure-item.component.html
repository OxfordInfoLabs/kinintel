<div class="configure-header">
    Configure {{dashboardItemType.label}}
    <button mat-icon-button mat-dialog-close>
        <mat-icon>close</mat-icon>
    </button>
</div>

<div class="configure-content">

    <rsz-layout class="row top" [directions]="['bottom']" [rFlex]="true">
        <div class="cell-contents">
            <ki-dataset-editor *ngIf="dashboardDatasetInstance" [(datasetInstanceSummary)]="dashboardDatasetInstance"
                               (dataLoaded)="dataLoaded($event)" [admin]="admin"
                               [dashboardParameters]="dashboard.layoutSettings.parameters"></ki-dataset-editor>
        </div>
    </rsz-layout>

    <rsz-layout class="row bottom" [directions]="['none']" [rFlex]="false">
        <mat-tab-group>
            <mat-tab label="General">
                <div class="w-1/2">
                    <div class="p-4">
                        <label class="mb-2">
                            Name
                            <input type="text" [(ngModel)]="general.name">
                            <small class="font-normal">Name of the item</small>
                        </label>
                        <label class="mb-2">
                            Description
                            <input type="text" [(ngModel)]="general.description">
                            <small class="font-normal">Description of the data item.</small>
                        </label>
                        <label class="mb-2">
                            Call to action
                            <select matNativeControl [(ngModel)]="callToAction" [compareWith]="setCallToActionItem"
                                    (ngModelChange)="ctaUpdate($event)">
                                <option value="">None</option>
                                <option [ngValue]="{type: 'custom'}">Custom Link</option>
                                <optgroup label="Dashboards">
                                    <option *ngFor="let dashboard of dashboards"
                                            [ngValue]="{type: 'dashboard', value: dashboard.id, label: dashboard.title}">{{dashboard.title}}</option>
                                </optgroup>
                            </select>
                            <small class="font-normal">Select the destination for the action link</small>
                        </label>
                        <ng-template [ngIf]="callToAction.type === 'custom'">
                            <p>Please enter the link for this call to action.</p>

                            <label class="mb-2">
                                Link
                                <input type="text" [(ngModel)]="callToAction.link">
                            </label>

                        </ng-template>

                        <label class="mb-2">
                            Set action label
                            <input type="text" [(ngModel)]="callToAction.label">
                        </label>

                        <ng-template [ngIf]="callToAction && dashboardParameters.length">
                            <p>Please enter the following parameters to use with this dashboard</p>

                            <ng-template ngFor let-param [ngForOf]="dashboardParameters">
                                <label>{{param.title}}</label>
                                <label *ngIf="!callToAction.parameters['custom-'+param.name]"
                                       class="mb-2 dashboard-param-pick">
                                    <select matNativeControl [(ngModel)]="callToAction.parameters[param.name]"
                                            [compareWith]="ctaSelectOption">
                                        <option [value]="undefined">-- Select Value --</option>
                                        <option *ngFor="let paramValue of dashboardParamValues"
                                                [value]="paramValue">
                                            {{paramValue}}
                                        </option>
                                    </select>
                                </label>
                                <div class="mb-2 flex items-center">
                                    <mat-checkbox class="mr-1"
                                                  [(ngModel)]="callToAction.parameters['custom-'+param.name]"></mat-checkbox>
                                    <p class="mb-0 mt-1">Use custom value</p>
                                </div>
                                <label class="mb-2 dashboard-param-pick">
                                    <input type="text" *ngIf="callToAction.parameters['custom-'+param.name]"
                                           placeholder="Enter custom parameter value"
                                           [(ngModel)]="callToAction.parameters[param.name]">
                                </label>
                            </ng-template>


                        </ng-template>
                    </div>
                </div>

            </mat-tab>
            <mat-tab label="Dependencies">
                <div class="flex justify-between">
                    <div class="w-1/2">
                        <div class="p-4">
                            <label class="mb-2">
                                Select the dashboard item(s) this depends on
                                <mat-select [(ngModel)]="dependencies.instanceKeys" multiple>
                                    <mat-option *ngFor="let instance of dashboard.datasetInstances"
                                                [value]="instance.instanceKey">
                                        {{dashboard.layoutSettings.general ? (dashboard.layoutSettings.general[instance.instanceKey] ? dashboard.layoutSettings.general[instance.instanceKey].name || instance.instanceKey : instance.instanceKey) : instance.instanceKey }}
                                    </mat-option>
                                </mat-select>
                            </label>

                            <ng-template ngFor let-instanceKey [ngForOf]="dependencies.instanceKeys">
                                <label class="mb-2">
                                    Dependency result type for
                                    {{dashboard.layoutSettings.general ? (dashboard.layoutSettings.general[instanceKey] ? dashboard.layoutSettings.general[instanceKey].name || instanceKey : instanceKey) : instanceKey }}
                                    <mat-select [(ngModel)]="dependencies[instanceKey]" [compareWith]="depSelection"
                                                (ngModelChange)="updateInstanceFilterFields($event, instanceKey)">
                                        <mat-option [value]="{type: 'LOADED'}">Loaded</mat-option>
                                        <mat-option [value]="{type: 'MATCH', filterJunction: _.clone(filterJunction), key: instanceKey}">
                                            Matches Criteria
                                        </mat-option>
                                    </mat-select>
                                </label>

                                <ng-template
                                    [ngIf]="dependencies[instanceKey] && dependencies[instanceKey].type === 'MATCH'">
                                    <div class="w-full flex items-center" *ngIf="!dependencies[instanceKey].filterFields">
                                        Loading filter component...
                                    </div>
                                    <ki-dataset-filters *ngIf="dependencies[instanceKey].filterFields" class="ml-0"
                                                        [filterJunction]="dependencies[instanceKey].filterJunction"
                                                        [filterFields]="dependencies[instanceKey].filterFields"></ki-dataset-filters>
                                </ng-template>

                            </ng-template>

                        </div>
                    </div>
                    <div class="w-1/2">
                        <div class="p-4">
                            <label class="mb-2">
                                No data notice message
                                <input type="text" [(ngModel)]="dependencies.notice">
                                <small class="font-normal">Enter the message to display when no data is returned from dependency.</small>
                            </label>
                        </div>
                    </div>
                </div>

            </mat-tab>
            <mat-tab label="Text" *ngIf="dashboardItemType.type === 'text'">
                <div class="w-1/2">
                    <div class="p-4">
                        <label class="mb-2">
                            Enter the HTML/Text for this item
                            <textarea class="font-mono"
                                      cols="30" rows="10" [(ngModel)]="textData.value"></textarea>
                        </label>
                    </div>
                </div>
            </mat-tab>
            <mat-tab label="Image" *ngIf="dashboardItemType.type === 'image'">
                <div class="w-1/2">
                    <div class="p-4">
                        <label class="mb-2">
                            Select the column that corresponds to the desired image
                            <select matNativeControl [(ngModel)]="imageData.column"
                                    (ngModelChange)="setImageData($event)">
                                <option [value]="undefined">-- Select Column --</option>
                                <ng-template [ngIf]="dataset">
                                    <option *ngFor="let column of dataset.columns"
                                            [value]="column.name">
                                        {{column.title}}
                                    </option>
                                </ng-template>
                            </select>
                        </label>
                    </div>
                </div>
            </mat-tab>
            <mat-tab label="Table" *ngIf="dashboardItemType.type === 'table'">
                <div class="w-1/2">
                    <div class="p-4">
                        <div class="mb-4 flex items-center">
                            <mat-checkbox class="mr-2" [(ngModel)]="tabular.actionRows"></mat-checkbox>
                            <p class="mb-0 mt-1">Make table rows clickable</p>
                        </div>

                        <ng-template [ngIf]="tabular.actionRows">
                            <label class="mb-2">
                                Call to action
                                <select matNativeControl [(ngModel)]="tabular.cta"
                                        [compareWith]="setCallToActionItem"
                                        (ngModelChange)="ctaUpdate($event)">
                                    <option value="">None</option>
                                    <option [ngValue]="{type: 'custom'}">Custom Link</option>
                                    <optgroup label="Dashboards">
                                        <option *ngFor="let dashboard of dashboards"
                                                [ngValue]="{type: 'dashboard', value: dashboard.id, label: dashboard.title}">{{dashboard.title}}</option>
                                    </optgroup>
                                </select>
                                <small class="font-normal">Select the destination for the action link</small>
                            </label>
                            <ng-template [ngIf]="tabular.cta.type === 'custom'">
                                <p>Please enter the link for this call to action.</p>

                                <label class="mb-2">
                                    Link
                                    <input type="text" [(ngModel)]="tabular.cta.link">
                                </label>

                            </ng-template>

                            <ng-template [ngIf]="tabular.cta && dashboardParameters.length">
                                <p>Please enter the following parameters to use with this dashboard</p>

                                <ng-template ngFor let-param [ngForOf]="dashboardParameters">
                                    <label>{{param.title}}</label>
                                    <label *ngIf="!tabular.cta.parameters['custom-'+param.name]"
                                           class="mb-2 dashboard-param-pick">
                                        <select matNativeControl [(ngModel)]="tabular.cta.parameters[param.name]"
                                                [compareWith]="ctaSelectOption">
                                            <option [value]="undefined">-- Select Value --</option>
                                            <ng-template [ngIf]="dataset">
                                                <option *ngFor="let column of dataset.columns"
                                                        [value]="'[['+column.name+']]'">
                                                    {{column.title}}
                                                </option>
                                            </ng-template>
                                        </select>
                                    </label>
                                    <div class="mb-2 flex items-center">
                                        <mat-checkbox class="mr-2"
                                                      [(ngModel)]="tabular.cta.parameters['custom-'+param.name]"></mat-checkbox>
                                        <p class="mb-0 mt-1">Use custom value</p>
                                    </div>
                                    <label class="mb-2 dashboard-param-pick">
                                        <input type="text" *ngIf="tabular.cta.parameters['custom-'+param.name]"
                                               placeholder="Enter custom parameter value"
                                               [(ngModel)]="tabular.cta.parameters[param.name]">
                                    </label>
                                </ng-template>
                            </ng-template>
                        </ng-template>
                    </div>

                </div>


            </mat-tab>
            <mat-tab label="Metric" *ngIf="dashboardItemType.type === 'metric'">
                <div class="p-4 flex justify-between">
                    <div class="flex-grow p-4">
                        <label class="mb-4">
                            Main Metric
                            <select [(ngModel)]="metric.main" (ngModelChange)="updateMetricDataValues()">
                                <option value="">-- Select Main Metric --</option>
                                <option [value]="field.name" *ngFor="let field of filterFields">
                                    {{field.title}}
                                </option>
                            </select>
                        </label>
                        <label class="mb-4">
                            Main Metric Format
                            <select [(ngModel)]="metric.mainFormat" (ngModelChange)="updateMetricDataValues()">
                                <option value="">Automatic</option>
                                <option [value]="format" *ngFor="let format of metricFormats">
                                    {{format}}
                                </option>
                            </select>
                        </label>
                        <ng-template [ngIf]="metric.mainFormat">
                            <label class="mb-4">
                                Decimals
                                <input type="number" [(ngModel)]="metric.mainFormatDecimals"
                                       (ngModelChange)="updateMetricDataValues()">
                            </label>
                        </ng-template>
                        <ng-template [ngIf]="metric.mainFormat === 'Currency'">
                            <label class="mb-4">
                                Currency
                                <select [(ngModel)]="metric.mainFormatCurrency"
                                        (ngModelChange)="updateMetricDataValues()">
                                    <option value="">-- Select Currency --</option>
                                    <option [value]="currency.value" *ngFor="let currency of currencies">
                                        {{currency.name}}
                                    </option>
                                </select>
                            </label>
                        </ng-template>

                        <hr>

                        <label class="mb-4">
                            Sub Metric
                            <select [(ngModel)]="metric.subMetric" (ngModelChange)="updateMetricDataValues()">
                                <option value="">-- Select Sub Metric --</option>
                                <option [value]="field.name" *ngFor="let field of filterFields">
                                    {{field.title}}
                                </option>
                            </select>
                        </label>
                        <label class="mb-4">
                            Sub Metric Format
                            <select [(ngModel)]="metric.subMetricFormat" (ngModelChange)="updateMetricDataValues()">
                                <option value="">Automatic</option>
                                <option [value]="format" *ngFor="let format of metricFormats">
                                    {{format}}
                                </option>
                            </select>
                        </label>
                        <ng-template [ngIf]="metric.subMetricFormat">
                            <label class="mb-4">
                                Decimals
                                <input type="number" [(ngModel)]="metric.subMetricFormatDecimals"
                                       (ngModelChange)="updateMetricDataValues()">
                            </label>
                        </ng-template>
                        <ng-template [ngIf]="metric.subMetricFormat === 'Currency'">
                            <label class="mb-4">
                                Currency
                                <select [(ngModel)]="metric.subMetricFormatCurrency"
                                        (ngModelChange)="updateMetricDataValues()">
                                    <option value="">-- Select Currency --</option>
                                    <option [value]="currency.value" *ngFor="let currency of currencies">
                                        {{currency.name}}
                                    </option>
                                </select>
                            </label>
                        </ng-template>

                        <mat-slide-toggle [(ngModel)]="metric.showSubChange" class="mb-4"
                                          (ngModelChange)="updateMetricDataValues()">
                            Show Metric Change
                        </mat-slide-toggle>
                    </div>

                    <div class="w-6/12 p-4">
                        <p><b>Preview</b></p>

                        <div class="metric-preview">

                            <div class="metric-item">
                                <div class="main">{{metric.mainValue}}</div>
                                <div class="sub-metric" [innerHTML]="metric.subValue"></div>
                            </div>

                        </div>
                    </div>
                </div>

            </mat-tab>
            <mat-tab label="Chart" *ngIf="chartTypes.indexOf(dashboardItemType.type) > -1">
                <div class="p-4 flex justify-between">
                    <div class="flex-grow p-4">
                        <label class="mb-4">
                            Chart Type
                            <select [(ngModel)]="dashboardItemType.type">
                                <option value="line">Line</option>
                                <option value="bar">Bar</option>
                                <option value="pie">Pie</option>
                                <option value="doughnut">Doughnut</option>
                            </select>
                        </label>

                        <label class="mb-4">
                            <ng-template
                                [ngIf]="dashboardItemType.type !== 'pie' && dashboardItemType.type !== 'doughnut'">
                                X Axis Column
                            </ng-template>
                            <ng-template
                                [ngIf]="dashboardItemType.type === 'pie' || dashboardItemType.type === 'doughnut'">
                                Labels Column
                            </ng-template>
                            <select [(ngModel)]="dashboardItemType.xAxis" (ngModelChange)="setChartData()">
                                <option value="">-- Select
                                    <ng-template
                                        [ngIf]="dashboardItemType.type !== 'pie' && dashboardItemType.type !== 'doughnut'">
                                        X
                                        Axis Column
                                    </ng-template>
                                    <ng-template
                                        [ngIf]="dashboardItemType.type === 'pie' || dashboardItemType.type === 'doughnut'">
                                        Labels Column
                                    </ng-template>
                                    --
                                </option>
                                <option [value]="field.name" *ngFor="let field of filterFields">
                                    {{field.title}}
                                </option>
                            </select>
                        </label>

                        <label class="mb-4">
                            <ng-template
                                [ngIf]="dashboardItemType.type !== 'pie' && dashboardItemType.type !== 'doughnut'">
                                Y Axis Column
                            </ng-template>
                            <ng-template
                                [ngIf]="dashboardItemType.type === 'pie' || dashboardItemType.type === 'doughnut'">
                                Values Column
                            </ng-template>
                            <select [(ngModel)]="dashboardItemType.yAxis" (ngModelChange)="setChartData()">
                                <option value="">-- Select
                                    <ng-template
                                        [ngIf]="dashboardItemType.type !== 'pie' && dashboardItemType.type !== 'doughnut'">
                                        Y
                                        Axis Column
                                    </ng-template>
                                    <ng-template
                                        [ngIf]="dashboardItemType.type === 'pie' || dashboardItemType.type === 'doughnut'">
                                        Values Column
                                    </ng-template>
                                    --
                                </option>
                                <option [value]="field.name" *ngFor="let field of filterFields">
                                    {{field.title}}
                                </option>
                            </select>
                        </label>

                        <div class="align-center justify-between">
                            <mat-slide-toggle [(ngModel)]="dashboardItemType.legend" class="mb-4">Show Legend
                            </mat-slide-toggle>
                            <mat-slide-toggle *ngIf="dashboardItemType.type === 'line'"
                                              [(ngModel)]="dashboardItemType.fill"
                                              (ngModelChange)="setChartData()" class="mb-4">Fill Background
                            </mat-slide-toggle>
                        </div>

                        <div class="mt-4 mb-4 align-center justify-between">
                            <label class="flex-1">
                                Border Colour
                                <input type="color" [(ngModel)]="dashboardItemType.borderColor">
                            </label>
                        </div>
                        <div class="mt-4 mb-4 align-center justify-between">
                            <label class="flex-1">
                                Background Colour
                                <ng-template [ngIf]="dashboardItemType.type !== 'line'">Range</ng-template>
                                <input type="color" [(ngModel)]="dashboardItemType.backgroundColorFrom"
                                       (ngModelChange)="backgroundColourUpdate()">
                            </label>
                            <label class="flex-1" *ngIf="dashboardItemType.type !== 'line'">
                                &nbsp;
                                <input type="color" [(ngModel)]="dashboardItemType.backgroundColorTo"
                                       (ngModelChange)="backgroundColourUpdate()">
                            </label>
                        </div>
                    </div>

                    <div class="w-6/12 p-4">


                        <canvas baseChart *ngIf="chartData"
                                [datasets]="chartData"
                                [labels]="dashboardItemType.labels"
                                [options]="{responsive: true}"
                                [colors]="[{borderColor: dashboardItemType.borderColor,backgroundColor: dashboardItemType.backgroundColor}]"
                                [legend]="!!dashboardItemType.legend"
                                [chartType]="dashboardItemType.type"
                                [plugins]="[]">
                        </canvas>
                    </div>

                </div>
            </mat-tab>
            <mat-tab label="Alert">
                <div class="p-4">
                    <div class="py-4 flex justify-between">
                        <div><b>Alerts</b></div>
                        <button mat-flat-button color="primary" (click)="editAlert(null)">
                            <mat-icon>add</mat-icon>
                            New Alert
                        </button>
                    </div>
                    <table *ngIf="dashboardDatasetInstance && dashboardDatasetInstance.alerts &&
                        dashboardDatasetInstance.alerts.length">
                        <thead>
                        <tr>
                            <th>Alert</th>
                            <th>Configuration</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let alert of dashboardDatasetInstance.alerts; let i = index">
                            <td>{{alert.title}}</td>
                            <td class="capitalize" [innerHTML]="getAlertDetails(alert)"></td>
                            <td class="text-right">
                                <div class="align-center justify-end">
                                    <button mat-button color="primary" (click)="editAlert(alert, i)"> Edit</button>
                                    <div class="divider"></div>
                                    <button mat-button color="warn" (click)="deleteAlert(i)"> Delete</button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                </div>
            </mat-tab>
        </mat-tab-group>
    </rsz-layout>

</div>

<div class="configure-footer">
    <button mat-stroked-button mat-dialog-close color="primary">
        Cancel
    </button>
    <button mat-flat-button color="primary" (click)="saveDashboard()">
        Save Changes
    </button>
</div>
