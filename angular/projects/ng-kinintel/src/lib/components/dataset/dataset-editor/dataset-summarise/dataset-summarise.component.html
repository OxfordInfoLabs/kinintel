<div class="dialog" cdkDrag cdkDragRootElement=".cdk-overlay-pane">

    <div class="dialog-title" cdkDragHandle>
        <h2 mat-dialog-title>Summarise Data</h2>

        <button mat-icon-button mat-dialog-close>
            <mat-icon>clear</mat-icon>
        </button>
    </div>

    <div class="dialog-content">

        <div class="drop-container" cdkDropListGroup>
            <div class="example-container">
                <h2>Available Columns</h2>

                <div
                    cdkDropList
                    id="availableColumns"
                    [cdkDropListData]="availableColumns"
                    class="example-list"
                    cdkDropListSortingDisabled
                    (cdkDropListDropped)="drop($event)">
                    <div class="example-box" *ngFor="let item of availableColumns" cdkDrag>{{item.title}}</div>
                </div>
            </div>

            <div class="example-container">
                <h2>Summarise Fields</h2>

                <div
                    cdkDropList
                    [cdkDropListData]="summariseFields"
                    class="example-list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="example-box" *ngFor="let item of summariseFields; let i = index" cdkDrag>
                        {{item.title}}
                        <button mat-icon-button color="warn" (click)="removeListItem(summariseFields, i)">
                            <mat-icon>remove_circle_outline</mat-icon>
                        </button>
                    </div>
                </div>
            </div>

            <div class="example-container">
                <h2>Summarise Expressions</h2>

                <div
                    cdkDropList
                    [cdkDropListData]="summariseExpressions"
                    id="summariseExpressions"
                    class="example-list"
                    (cdkDropListDropped)="drop($event)">
                    <div class="example-box expression" *ngFor="let item of summariseExpressions; let i = index"
                         cdkDrag >
                        <ng-template [ngIf]="item.expressionType !== 'CUSTOM'">
                            <div class="top">
                                <mat-select [(ngModel)]="item.expressionType">
                                    <mat-option *ngFor="let type of expressionTypes"
                                                [value]="type">{{type}}</mat-option>
                                </mat-select>
                                {{item.title}}

                                <button mat-icon-button color="warn" (click)="removeListItem(summariseExpressions, i)">
                                    <mat-icon>remove_circle_outline</mat-icon>
                                </button>
                            </div>
                        </ng-template>
                        <ng-template [ngIf]="item.expressionType === 'CUSTOM'">
                            <div class="top">
                                <div class="custom-container">
                                    <div class="align-center justify-between">
                                        <b>Custom expression</b>
                                        <button mat-icon-button color="warn" (click)="removeListItem(summariseExpressions, i)">
                                            <mat-icon>remove</mat-icon>
                                        </button>
                                    </div>
                                    <textarea rows="4" [(ngModel)]="item.customExpression"></textarea>
                                </div>

                            </div>
                        </ng-template>
                        <div class="bottom">
                            <span>Label<span class="text-red-500 text-xs">&nbsp;*</span></span>
                            <input type="text" [placeholder]="item.expressionType === 'CUSTOM' ? 'custom_expression' : item.expressionType + '_of_' + item.name"
                                   [(ngModel)]="item.customLabel" [ngClass]="{'border border-red-500': !item.customLabel}">
                        </div>


                    </div>
                </div>

            </div>
        </div>

        <ki-whitelisted-sql-functions *ngIf="showDocs" [fields]="availableColumns"></ki-whitelisted-sql-functions>

    </div>

    <div class="dialog-footer">
        <button mat-button mat-dialog-close>Cancel</button>

        <div class="flex items-center">
            <a (click)="showDocs = !showDocs"
               class="text-xs mr-2 hover:underline flex items-center primary">
                view help docs&nbsp;
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                     fill="currentColor">
                    <path
                        d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
                    <path
                        d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
                </svg>
            </a>
            <button mat-stroked-button color="primary" (click)="createCustomExpression()"
                class="create-custom-button">
                <mat-icon>construction</mat-icon>
                Create custom expression
            </button>
            <button mat-flat-button color="primary" (click)="applySettings()"
                [disabled]="!_.every(summariseExpressions, 'customLabel')">Apply Settings</button>
        </div>

    </div>

</div>


