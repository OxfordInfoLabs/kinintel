<div class="dialog" cdkDrag cdkDragRootElement=".cdk-overlay-pane">

    <div class="dialog-title" cdkDragHandle>
        <h2 mat-dialog-title>Join Data</h2>

        <button mat-icon-button mat-dialog-close>
            <mat-icon>clear</mat-icon>
        </button>
    </div>

    <div class="dialog-content pt-0 pr-0 pb-4 pl-0">

        <mat-horizontal-stepper [linear]="true" #stepper>
            <mat-step [completed]="selectedSource" label="Select data">

                <div class="mb-8 mt-4">
                    <input class="full" type="text" placeholder="Search for a datasource or dataset"
                           (keyup)="searchText.next($event.target.value)">
                </div>

                <table class="min-w-full border-separate" style="border-spacing: 0">
                    <ng-template ngFor let-tableKey [ngForOf]="Object.keys(tableData)">
                        <thead class="bg-gray-100">
                        <tr>
                            <th scope="col"
                                class="sticky top-0 z-10 border-b border-gray-300 bg-gray-50 bg-opacity-75 py-3.5 px-4 text-left text-xs font-semibold text-gray-900 backdrop-blur backdrop-filter">
                                {{tableData[tableKey].title}}
                            </th>
                            <th scope="col"
                                class="sticky top-0 z-10 border-b border-gray-300 bg-gray-50 bg-opacity-75 py-3.5 px-4 backdrop-blur backdrop-filter">
                                <span class="sr-only">Edit</span>
                            </th>
                        </tr>
                        </thead>
                        <tbody class="bg-white">
                        <tr *ngFor="let dataItem of tableData[tableKey].data">
                            <td class="whitespace-nowrap border-b border-gray-200 py-2 px-4 text-sm font-medium text-gray-900">
                                <div class="flex flex-col">
                                    <div>{{dataItem.title || dataItem.fullTitle}}</div>
                                    <div *ngIf="dataItem.summary"
                                         class="text-gray-400 font-thin w-2/3 overflow-ellipsis overflow-hidden whitespace-nowrap">
                                        {{dataItem.summary}}
                                    </div>
                                </div>

                            </td>
                            <td class="relative whitespace-nowrap border-b border-gray-200 py-2 px-4 text-right text-sm">
                                <button mat-button color="primary" (click)="select(dataItem, tableData[tableKey].type, stepper)">
                                    Select
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5"
                                class="whitespace-nowrap border-b border-gray-200 py-2 px-4 text-sm font-medium text-gray-900">
                                <div *ngIf="!tableData[tableKey].data.length" class="font-normal">
                                    No {{tableData[tableKey].type}}s
                                </div>
                                <div class="paging-toolbar flex align-center justify-end" *ngIf="tableData[tableKey].data.length">
                                    <select [value]="tableData[tableKey].limit" (change)="pageSizeChange($event.target.value, tableData[tableKey])"
                                            class="mr-8">
                                        <option [value]="1">1</option>
                                        <option [value]="5">5</option>
                                        <option [value]="10">10</option>
                                        <option [value]="25">25</option>
                                        <option [value]="50">50</option>
                                        <option [value]="100">100</option>
                                        <option [value]="250">250</option>
                                        <option [value]="1000">1000</option>
                                    </select>
                                    <button mat-icon-button class="mr-4" (click)="decreaseOffset(tableData[tableKey])" [disabled]="tableData[tableKey].page <= 1">
                                        <mat-icon>chevron_left</mat-icon>
                                    </button>
                                    <button mat-icon-button (click)="increaseOffset(tableData[tableKey])" [disabled]="tableData[tableKey].endOfResults">
                                        <mat-icon>chevron_right</mat-icon>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </ng-template>
                </table>
            </mat-step>
            <mat-step *ngIf="requiredParameters && requiredParameters.length"
                      [completed]="joinTransformation.config.joinParameterMappings.length >= 1"
                      label="Required parameters">
                <ng-template [ngIf]="!selectedSource">
                    <p>Please select either a Datasource or Dataset to join to.</p>
                </ng-template>

                <ng-template [ngIf]="selectedSource">
                    <p class="mb-4">
                        <b *ngIf="!joinTransformation.config.joinedDataItemTitle">Selected source: {{selectedSource.title || selectedSource.name}}</b>
                        <b *ngIf="joinTransformation.config.joinedDataItemTitle">Selected source: {{joinTransformation.config.joinedDataItemTitle}}</b>
                    </p>

                    <div class="mb-4" *ngIf="requiredParameters && requiredParameters.length">
                        <ki-dataset-parameter-values [parameterValues]="requiredParameters" [hideNew]="true"
                                                     [update]="updateParams"
                                                     (changed)="setEvaluatedParameters($event, stepper)"></ki-dataset-parameter-values>
                    </div>

                </ng-template>
            </mat-step>
            <mat-step *ngIf="!requiredParameters || !requiredParameters.length"
                      [completed]="(!joinFilterFields || !joinFilterFields.length) ||
                        (_.every(joinTransformation.config.joinFilters.filters, 'lhsExpression') &&
                                   _.every(joinTransformation.config.joinFilters.filters, 'rhsExpression'))"
                      label="Join criteria">

                <ng-template [ngIf]="!selectedSource">
                    <p>Please select either a Datasource or Dataset to join to.</p>
                </ng-template>

                <ng-template [ngIf]="selectedSource">
                    <p class="mb-4">
                        <b *ngIf="!joinTransformation.config.joinedDataItemTitle">Selected source: {{selectedSource.title || selectedSource.name}}</b>
                        <b *ngIf="joinTransformation.config.joinedDataItemTitle">Selected source: {{joinTransformation.config.joinedDataItemTitle}}</b>
                    </p>
                    <div class="my-4">
                        <mat-checkbox [(ngModel)]="joinTransformation.config.strictJoin">Strict Join?</mat-checkbox>
                        <p><small>If turned on, data will be pruned to only return rows that match.</small></p>
                    </div>

                    <ki-dataset-filters *ngIf="joinFilterFields" [filterFields]="filterFields"
                                        [joinFilterFields]="joinFilterFields" [openSide]="openSide"
                                        [joinFieldsName]="selectedSource.title || selectedSource.name"
                                        [filterJunction]="joinTransformation.config.joinFilters"></ki-dataset-filters>

                    <ng-template [ngIf]="openSide.getValue()">
                        <ki-whitelisted-sql-functions [fields]="filterFields"></ki-whitelisted-sql-functions>
                    </ng-template>

                </ng-template>

            </mat-step>

            <mat-step *ngIf="!requiredParameters || !requiredParameters.length" [completed]="false" label="Column definition">

                <ng-template [ngIf]="!selectedSource">
                    <p>Please select either a Datasource or Dataset to join to.</p>
                </ng-template>

                <ng-template [ngIf]="selectedSource">
                    <p class="mb-4">
                        <b *ngIf="!joinTransformation.config.joinedDataItemTitle">Selected source: {{selectedSource.title || selectedSource.name}}</b>
                        <b *ngIf="joinTransformation.config.joinedDataItemTitle">Selected source: {{joinTransformation.config.joinedDataItemTitle}}</b>
                    </p>

                    <p>Select the columns you would like to view, and set a new column name if required.</p>

                    <div class="column-definition align-center">
                        <mat-checkbox [(ngModel)]="allColumns" (change)="toggleAllColumns($event)"></mat-checkbox>
                        <label class="mw">Column Name</label>
                        <label class="mw">New Column Title</label>
                    </div>

                    <div class="column-definition align-center" *ngFor="let column of joinColumns">
                        <mat-checkbox [(ngModel)]="column.selected" (ngModelChange)="allSelected()"></mat-checkbox>
                        <label>
                            <input type="text" [(ngModel)]="column.name" disabled>
                        </label>
                        <label>
                            <input type="text" [(ngModel)]="column.title">
                        </label>
                        <span *ngIf="column.duplicate" class="primary">Duplicate column name</span>
                    </div>
                </ng-template>

            </mat-step>

        </mat-horizontal-stepper>

    </div>

    <div class="dialog-footer">

        <!-- BACK/CANCEL BUTTONS-->
        <button *ngIf="stepper.selectedIndex === 0" mat-stroked-button color="primary" mat-dialog-close>Cancel</button>
        <button *ngIf="stepper.selectedIndex > 0" mat-stroked-button color="primary" (click)="stepper.previous()">Back
        </button>

        <!-- MIDDLE NEXT BUTTONS -->
        <ng-template [ngIf]="stepper.selectedIndex === 1">
            <ng-template [ngIf]="!requiredParameters || !requiredParameters.length">
                <button mat-flat-button color="primary" (click)="stepper.next()"
                        [disabled]="(joinFilterFields && joinFilterFields.length) &&
                                !(_.every(joinTransformation.config.joinFilters.filters, 'lhsExpression') &&
                                   _.every(joinTransformation.config.joinFilters.filters, 'rhsExpression'))">
                    Next
                </button>
            </ng-template>

            <ng-template [ngIf]="requiredParameters && requiredParameters.length">
                <button mat-flat-button color="primary" (click)="getParameterValues()">
                    Create Join
                </button>
            </ng-template>
        </ng-template>
        <!-- FINAL BUTTON -->
        <button mat-flat-button color="primary" *ngIf="stepper.selectedIndex === 2" (click)="join()">
            Create Join
        </button>
    </div>

</div>


